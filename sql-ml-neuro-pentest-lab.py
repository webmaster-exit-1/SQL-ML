import os
import sys
import time
import subprocess
import requests
import sqlite3
import signal
from flask import Flask, request, jsonify

# --- LAB CONFIGURATION ---
KITE_DOMAIN = "sql-ml-lab" 
API_HOST = "127.0.0.1"
API_PORT = 8775
WEB_PORT = 5000
DB_FILE = os.path.abspath("sqlmap_internal.db")
VICTIM_DB = "victim_data.db"
# Path to YOUR bridge script
ML_BRIDGE_PATH = os.path.abspath("sqlmap_ml_bridge.py")

# --- 1. THE VICTIM (Local Website with SQLite) ---
def setup_victim_db():
    conn = sqlite3.connect(VICTIM_DB)
    curr = conn.cursor()
    curr.execute("DROP TABLE IF EXISTS products")
    curr.execute("CREATE TABLE products (id INTEGER, name TEXT, secret TEXT)")
    curr.execute("INSERT INTO products VALUES (1, 'Neural Processor', 'FLAG{ML_INJECTION_SUCCESS}')")
    curr.execute("INSERT INTO products VALUES (2, 'Bio-Link', 'SECRET_8821')")
    conn.commit()
    conn.close()

# --- 2. THE ORCHESTRATOR ---
class SQLML_Lab:
    def __init__(self):
        self.procs = {}
        setup_victim_db()

    def spawn(self, name, cmd):
        print(f"[*] Launching {name}...")
        self.procs[name] = subprocess.Popen(
            cmd, 
            stdout=subprocess.PIPE, 
            stderr=subprocess.STDOUT, 
            text=True
        )

    def start_all(self):
        # 1. Start sqlmapapi
        self.spawn("API_SERVER", [
            sys.executable, "-m", "sqlmap.lib.utils.api", 
            "-s", "-H", API_HOST, "-p", str(API_PORT), "--database", DB_FILE
        ])

        # 2. Start Victim Web App (Flask)
        victim_code = f"""
from flask import Flask, request
import sqlite3
app = Flask('Victim')
@app.route('/api/search')
def search():
    val = request.args.get('id', '1')
    conn = sqlite3.connect('{VICTIM_DB}')
    query = f"SELECT name, secret FROM products WHERE id = {{val}}"
    try:
        res = conn.execute(query).fetchall()
        return str(res)
    except Exception as e:
        return str(e), 500
app.run(port={WEB_PORT})
"""
        self.spawn("WEB_VICTIM", [sys.executable, "-c", victim_code])

        # 3. Start Pagekite Tunnel
        self.spawn("TUNNEL", ["pagekite.py", str(WEB_PORT), f"{KITE_DOMAIN}.pagekite.me"])

    def shutdown(self, *args):
        print("\n[!] Deactivating Neural Lab...")
        for proc in self.procs.values():
            proc.terminate()
        if os.path.exists(DB_FILE): os.remove(DB_FILE)
        if os.path.exists(VICTIM_DB): os.remove(VICTIM_DB)
        sys.exit(0)

# --- 3. THE SQL-ML CONNECTOR (The part you asked about) ---
class SQLML_Bridge:
    def __init__(self, api_url):
        self.api_url = api_url

    def create_optimization_task(self, target_url):
        """
        This is the core interaction logic. 
        It creates a task in sqlmapapi and tells it to use YOUR ML bridge.
        """
        print(f"[*] SQL-ML Bridge: Initializing Task for {target_url}")
        try:
            # Step A: Request a new task ID from the API
            r = requests.get(f"{self.api_url}/task/new").json()
            task_id = r.get("taskid")
            
            # Step B: Configure the task.
            # We add 'preprocess': ML_BRIDGE_PATH so sqlmap runs your bridge script.
            options = {
                "url": target_url,
                "batch": True,
                "preprocess": ML_BRIDGE_PATH, 
                "getBanner": True
            }
            
            # Step C: Send options and start the scan
            requests.post(f"{self.api_url}/option/{task_id}/set", json=options)
            requests.post(f"{self.api_url}/scan/{task_id}/start", json={})
            
            return task_id
        except Exception as e:
            print(f"[!] Bridge Error: {e}")
            return None

if __name__ == "__main__":
    lab = SQLML_Lab()
    signal.signal(signal.SIGINT, lab.shutdown)
    lab.start_all()
    
    # Wait for servers to stabilize
    time.sleep(5) 
    
    bridge = SQLML_Bridge(f"http://{API_HOST}:{API_PORT}")
    target = f"https://{KITE_DOMAIN}.pagekite.me/api/search?id=1"
    
    tid = bridge.create_optimization_task(target)
    if tid:
        print(f"[+] Task {tid} is now active and linked to your ML pipeline.")
        
    while True:
        time.sleep(1)
